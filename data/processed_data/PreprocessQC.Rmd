---
title: "PreprocessQC"
author: "Victor, Ming, Michael"
output: 
  html_document: 
    keep_md: yes
---

```{r, load libraries, message=FALSE}
library(minfi)
library(dplyr)
library(ggplot2)
```

```{r, read data}
getwd()
#input the right base directory
setwd("../Raw Data/")
basedir <- getwd()
# read in sample sheet .csv file
samplesheet <- read.metharray.sheet(basedir, recursive = TRUE)
# read in iDAT files using sample sheet
Eth_rgset <- read.metharray.exp(targets = samplesheet)

```

```{r}
# phenotype data (from sample sheet)
pheno <- pData(Eth_rgset)
pheno[,1:6]
# manifest
mani <- getManifest(Eth_rgset)
```
Try different preporcessing methods:

* Noob: "Implements the noob background subtraction method with dye-bias normalization"
* Functional Normalization: "This function applies the preprocessNoob function as a first step for background substraction, and uses the first two principal components of the control probes to infer the unwanted variation"
* Quantile Normalization: "Implements stratified quantile normalization preprocessing"

```{r}
# noob 
eth_proproc_noob <- preprocessNoob(Eth_rgset)
eth_proproc_noob
# functional normalization
eth_preproc_funnorm <- preprocessFunnorm(Eth_rgset)
eth_preproc_funnorm
# quantile normalization
eth_preproc_quant <- preprocessQuantile(Eth_rgset,fixOutliers = TRUE,
  removeBadSamples = FALSE, quantileNormalize = TRUE, stratified = TRUE, 
  mergeManifest = FALSE, sex = NULL)
eth_preproc_quant
## later on we can use getSex() on preprocessed data to double check genders for each observation
```


Compare different preprocessing methods:

Credit: https://github.com/swils6/PE_IUGR_DataPreprocessing/blob/master/PE_IUGR_FNormalization_Jan2016.md

```{r}

probeTypes <- data.frame(Name = featureNames(eth_proproc_noob),
                         Type = getProbeType(eth_proproc_noob))


par(mfrow = c(1, 2))
# can't plot noob for now, will fix later
#plotBetasByType(eth_preproc_noob, main = "Noob")
plotBetasByType(getBeta(eth_preproc_funnorm[,1]), main = "Functional Normalization", probeTypes = probeTypes)
plotBetasByType(getBeta(eth_preproc_quant[,1]), main = "Quantile Normalization", probeTypes = probeTypes)


```

A good preprocessing method should make the peaks of type 1 & 2 probe distributions close together, so functional normalization appears to be better.

QC
```{r}
qc <- getQC(MSet)
plotQC(qc)
densityPlot(MSet, sampGroups = phenoData$Sample_Group)
densityBeanPlot(MSet, sampGroups = phenoData$Sample_Group)
controlStripPlot(Eth_rgset, controls="BISULFITE CONVERSION II")
#Red is type 1, green is type 2
qcReport(Eth_rgset, pdf= "qcReport.pdf")
```

Comparing preprocessing methodology
```{r}
MSet.raw <- preprocessRaw(Eth_rgset)
MSet.raw <- MSet.raw[order(featureNames(MSet.raw)), ]

MSet.fnorm <- preprocessFunnorm(Eth_rgset, nPCs = 2, sex = NULL, bgCorr = TRUE, dyeCorr = TRUE, verbose = TRUE)
MSet.fnorm <- MSet.fnorm[order(featureNames(MSet.fnorm)), ]

MSet.qnorm <- preprocessQuantile(Eth_rgset, fixOutliers = TRUE, removeBadSamples = TRUE, badSampleCutoff = 10.5, quantileNormalize = TRUE, stratified = TRUE, mergeManifest = FALSE, sex = NULL)
MSet.qnorm <- MSet.qnorm[order(featureNames(MSet.qnorm)),]
    
probeTypes <- data.frame(Name = featureNames(MSet.raw),
                         Type = getProbeType(MSet.raw))
par(mfrow = c(2, 2))


#legendpos = "btm" is used to generate an error to remove the legend all together. 
plotBetasByType(MSet.raw[,1], main = "Raw", legendPos = "btm")
plotBetasByType(getBeta(MSet.fnorm[,1]), probeTypes = probeTypes, main = "funNorm_noob", legendPos = "btm")
plotBetasByType(getBeta(MSet.qnorm[,1]), probeTypes = probeTypes, main = "Quantile", legendPos = "btm")
```
